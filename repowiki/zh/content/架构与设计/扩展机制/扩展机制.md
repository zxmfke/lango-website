# æ‰©å±•æœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [graph/listeners.go](file://graph/listeners.go)
- [graph/builtin_listeners.go](file://graph/builtin_listeners.go)
- [graph/tracing.go](file://graph/tracing.go)
- [graph/command.go](file://graph/command.go)
- [prebuilt/tool_executor.go](file://prebuilt/tool_executor.go)
- [examples/listeners/main.go](file://examples/listeners/main.go)
- [examples/command_api/main.go](file://examples/command_api/main.go)
- [graph/streaming.go](file://graph/streaming.go)
- [graph/graph.go](file://graph/graph.go)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [Listeners è®¾è®¡æ¨¡å¼](#listeners-è®¾è®¡æ¨¡å¼)
3. [Tracing åˆ†å¸ƒå¼è¿½è¸ª](#tracing-åˆ†å¸ƒå¼è¿½è¸ª)
4. [Command API åŠ¨æ€æ§åˆ¶æµ](#command-api-åŠ¨æ€æ§åˆ¶æµ)
5. [Streaming å®æ—¶æµå¼å¤„ç†](#streaming-å®æ—¶æµå¼å¤„ç†)
6. [æ‰©å±•æœºåˆ¶é›†æˆ](#æ‰©å±•æœºåˆ¶é›†æˆ)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
8. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

LangGraph Go æä¾›äº†ä¸€å¥—å®Œæ•´çš„æ‰©å±•æœºåˆ¶ï¼Œæ”¯æŒå¼€å‘è€…åœ¨è¿è¡Œæ—¶ç›‘æ§ã€è°ƒè¯•å’Œæ§åˆ¶å¤æ‚çš„å·¥ä½œæµæ‰§è¡Œã€‚è¿™äº›æ‰©å±•ç‚¹åŒ…æ‹¬ç›‘å¬å™¨ç³»ç»Ÿï¼ˆListenersï¼‰ã€åˆ†å¸ƒå¼è¿½è¸ªï¼ˆTracingï¼‰ã€å‘½ä»¤ APIï¼ˆCommand APIï¼‰å’Œå®æ—¶æµå¼å¤„ç†ï¼ˆStreamingï¼‰ã€‚è¿™äº›æœºåˆ¶å…±åŒæ„å»ºäº†ä¸€ä¸ªå¯è§‚å¯Ÿã€å¯è°ƒè¯•ä¸”é«˜åº¦å¯å®šåˆ¶çš„ç³»ç»Ÿæ¶æ„ã€‚

## Listeners è®¾è®¡æ¨¡å¼

### æ ¸å¿ƒæ¦‚å¿µ

Listeners æ˜¯ LangGraph Go ä¸­æœ€é‡è¦çš„æ‰©å±•æœºåˆ¶ä¹‹ä¸€ï¼Œé‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼è®¾è®¡ï¼Œå…è®¸å¼€å‘è€…åœ¨èŠ‚ç‚¹æ‰§è¡Œçš„ä¸åŒé˜¶æ®µæ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚

```mermaid
classDiagram
class NodeListener {
<<interface>>
+OnNodeEvent(ctx, event, nodeName, state, err)
}
class NodeListenerFunc {
+OnNodeEvent(ctx, event, nodeName, state, err)
}
class ListenableNode {
+Node
+listeners []NodeListener
+mutex sync.RWMutex
+AddListener(listener)
+RemoveListener(listener)
+NotifyListeners(ctx, event, state, err)
+Execute(ctx, state)
}
class ProgressListener {
+writer io.Writer
+nodeSteps map[string]string
+showTiming bool
+showDetails bool
+prefix string
+OnNodeEvent(ctx, event, nodeName, state, err)
}
class LoggingListener {
+logger *log.Logger
+logLevel LogLevel
+includeState bool
+OnNodeEvent(ctx, event, nodeName, state, err)
}
class MetricsListener {
+nodeExecutions map[string]int
+nodeDurations map[string][]time.Duration
+nodeErrors map[string]int
+totalExecutions int
+OnNodeEvent(ctx, event, nodeName, state, err)
}
NodeListener <|-- NodeListenerFunc
NodeListener <|-- ProgressListener
NodeListener <|-- LoggingListener
NodeListener <|-- MetricsListener
ListenableNode --> NodeListener : "notifies"
```

**å›¾è¡¨æ¥æº**
- [graph/listeners.go](file://graph/listeners.go#L51-L87)
- [graph/builtin_listeners.go](file://graph/builtin_listeners.go#L13-L433)

### ç”Ÿå‘½å‘¨æœŸé’©å­

Listeners æä¾›äº†ä¸°å¯Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œæ¶µç›–èŠ‚ç‚¹æ‰§è¡Œçš„å„ä¸ªé˜¶æ®µï¼š

| äº‹ä»¶ç±»å‹ | æè¿° | è§¦å‘æ—¶æœº |
|---------|------|----------|
| `NodeEventStart` | èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œ | èŠ‚ç‚¹å‡½æ•°è¢«è°ƒç”¨å‰ |
| `NodeEventProgress` | èŠ‚ç‚¹æ‰§è¡Œè¿›åº¦ | èŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»æ„æ—¶åˆ» |
| `NodeEventComplete` | èŠ‚ç‚¹æˆåŠŸå®Œæˆ | èŠ‚ç‚¹å‡½æ•°æ­£å¸¸è¿”å›æ—¶ |
| `NodeEventError` | èŠ‚ç‚¹æ‰§è¡Œé”™è¯¯ | èŠ‚ç‚¹å‡½æ•°è¿”å›éç©ºé”™è¯¯æ—¶ |
| `EventChainStart` | å›¾æ‰§è¡Œå¼€å§‹ | æ•´ä¸ªå›¾å¼€å§‹æ‰§è¡Œæ—¶ |
| `EventChainEnd` | å›¾æ‰§è¡Œç»“æŸ | æ•´ä¸ªå›¾æˆåŠŸå®Œæˆæ—¶ |
| `EventToolStart` | å·¥å…·è°ƒç”¨å¼€å§‹ | å·¥å…·èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œæ—¶ |
| `EventToolEnd` | å·¥å…·è°ƒç”¨ç»“æŸ | å·¥å…·èŠ‚ç‚¹å®Œæˆæ‰§è¡Œæ—¶ |
| `EventLLMStart` | LLMè°ƒç”¨å¼€å§‹ | LLMèŠ‚ç‚¹å¼€å§‹æ‰§è¡Œæ—¶ |
| `EventLLMEnd` | LLMè°ƒç”¨ç»“æŸ | LLMèŠ‚ç‚¹å®Œæˆæ‰§è¡Œæ—¶ |

### å†…ç½®ç›‘å¬å™¨ç±»å‹

#### ProgressListenerï¼ˆè¿›åº¦ç›‘å¬å™¨ï¼‰

æä¾›å¯è§†åŒ–çš„è¿›åº¦è·Ÿè¸ªåŠŸèƒ½ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯å’Œæ ¼å¼åŒ–é€‰é¡¹ï¼š

```mermaid
flowchart TD
A[èŠ‚ç‚¹å¼€å§‹] --> B[æ˜¾ç¤ºè‡ªå®šä¹‰æ¶ˆæ¯]
B --> C[è®°å½•å¼€å§‹æ—¶é—´]
C --> D[æ‰§è¡ŒèŠ‚ç‚¹é€»è¾‘]
D --> E{æ‰§è¡Œç»“æœ}
E --> |æˆåŠŸ| F[æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯]
E --> |å¤±è´¥| G[æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯]
F --> H[è®¡ç®—æ‰§è¡Œæ—¶é—´]
G --> H
H --> I[è¾“å‡ºåˆ°æŒ‡å®šWriter]
```

**å›¾è¡¨æ¥æº**
- [graph/builtin_listeners.go](file://graph/builtin_listeners.go#L70-L116)

#### LoggingListenerï¼ˆæ—¥å¿—ç›‘å¬å™¨ï¼‰

æä¾›ç»“æ„åŒ–æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œæ”¯æŒä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡ºï¼š

```mermaid
flowchart TD
A[æ¥æ”¶äº‹ä»¶] --> B{æ£€æŸ¥æ—¥å¿—çº§åˆ«}
B --> |æ»¡è¶³è¦æ±‚| C[æ ¼å¼åŒ–æ¶ˆæ¯]
B --> |ä¸æ»¡è¶³| D[å¿½ç•¥äº‹ä»¶]
C --> E{åŒ…å«çŠ¶æ€?}
E --> |æ˜¯| F[æ·»åŠ çŠ¶æ€ä¿¡æ¯]
E --> |å¦| G[ç›´æ¥è¾“å‡º]
F --> H[å†™å…¥æ—¥å¿—]
G --> H
H --> I[å®Œæˆ]
```

**å›¾è¡¨æ¥æº**
- [graph/builtin_listeners.go](file://graph/builtin_listeners.go#L165-L200)

#### MetricsListenerï¼ˆæŒ‡æ ‡ç›‘å¬å™¨ï¼‰

æ”¶é›†è¯¦ç»†çš„æ€§èƒ½å’Œæ‰§è¡ŒæŒ‡æ ‡ï¼š

| æŒ‡æ ‡ç±»å‹ | æ•°æ®ç»“æ„ | ç”¨é€” |
|---------|----------|------|
| èŠ‚ç‚¹æ‰§è¡Œæ¬¡æ•° | `map[string]int` | ç»Ÿè®¡æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œé¢‘ç‡ |
| èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´ | `map[string][]time.Duration` | è®¡ç®—å¹³å‡æ‰§è¡Œæ—¶é—´å’Œåˆ†å¸ƒ |
| èŠ‚ç‚¹é”™è¯¯æ¬¡æ•° | `map[string]int` | ç›‘æ§èŠ‚ç‚¹æ•…éšœç‡ |
| æ€»æ‰§è¡Œæ¬¡æ•° | `int` | å…¨å±€æ‰§è¡Œç»Ÿè®¡ |

#### ChatListenerï¼ˆèŠå¤©ç›‘å¬å™¨ï¼‰

æä¾›å®æ—¶èŠå¤©é£æ ¼çš„æ›´æ–°æç¤ºï¼š

```mermaid
sequenceDiagram
participant N as èŠ‚ç‚¹
participant CL as ChatListener
participant W as Writer
N->>CL : NodeEventStart
CL->>W : æ˜¾ç¤º"ğŸ¤– å¼€å§‹å¤„ç†..."
N->>CL : NodeEventComplete
CL->>W : æ˜¾ç¤º"âœ… å¤„ç†å®Œæˆ"
N->>CL : NodeEventError
CL->>W : æ˜¾ç¤º"âŒ é”™è¯¯ï¼šå…·ä½“é”™è¯¯ä¿¡æ¯"
```

**å›¾è¡¨æ¥æº**
- [graph/builtin_listeners.go](file://graph/builtin_listeners.go#L392-L432)

### ç›‘å¬å™¨ç®¡ç†

ListenableNode æä¾›äº†çµæ´»çš„ç›‘å¬å™¨ç®¡ç†æœºåˆ¶ï¼š

```mermaid
classDiagram
class ListenableNode {
+Node
+listeners []NodeListener
+mutex sync.RWMutex
+AddListener(listener)
+RemoveListener(listener)
+GetListeners() []NodeListener
+NotifyListeners(ctx, event, state, err)
+Execute(ctx, state)
}
class ListenableMessageGraph {
+MessageGraph
+listenableNodes map[string]*ListenableNode
+AddNode(name, fn)
+GetListenableNode(name)
+AddGlobalListener(listener)
+RemoveGlobalListener(listener)
}
ListenableMessageGraph --> ListenableNode : "manages"
ListenableNode --> NodeListener : "notifies"
```

**å›¾è¡¨æ¥æº**
- [graph/listeners.go](file://graph/listeners.go#L89-L234)

**ç« èŠ‚æ¥æº**
- [graph/listeners.go](file://graph/listeners.go#L1-L335)
- [graph/builtin_listeners.go](file://graph/builtin_listeners.go#L1-L433)
- [examples/listeners/main.go](file://examples/listeners/main.go#L1-L132)

## Tracing åˆ†å¸ƒå¼è¿½è¸ª

### æ¶æ„è®¾è®¡

Tracing æ¨¡å—æä¾›äº†ä¸å¤–éƒ¨è¿½è¸ªç³»ç»Ÿçš„é›†æˆèƒ½åŠ›ï¼Œæ”¯æŒ OpenTelemetry ç­‰æ ‡å‡†è¿½è¸ªåè®®ã€‚

```mermaid
classDiagram
class TraceSpan {
+ID string
+ParentID string
+Event TraceEvent
+NodeName string
+FromNode string
+ToNode string
+StartTime time.Time
+EndTime time.Time
+Duration time.Duration
+State interface{}
+Error error
+Metadata map[string]interface{}
}
class TraceHook {
<<interface>>
+OnEvent(ctx, span)
}
class Tracer {
+hooks []TraceHook
+spans map[string]*TraceSpan
+AddHook(hook)
+StartSpan(ctx, event, nodeName) *TraceSpan
+EndSpan(ctx, span, state, err)
+TraceEdgeTraversal(ctx, fromNode, toNode)
+GetSpans() map[string]*TraceSpan
+Clear()
}
class TracedRunnable {
+Runnable
+tracer *Tracer
+Invoke(ctx, initialState)
+GetTracer() *Tracer
}
TraceHook --> TraceSpan : "receives"
Tracer --> TraceSpan : "manages"
Tracer --> TraceHook : "notifies"
TracedRunnable --> Tracer : "uses"
```

**å›¾è¡¨æ¥æº**
- [graph/tracing.go](file://graph/tracing.go#L31-L287)

### è¿½è¸ªäº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | æè¿° | ç”¨é€” |
|---------|------|------|
| `TraceEventGraphStart` | å›¾æ‰§è¡Œå¼€å§‹ | æ ‡è®°æ•´ä¸ªå·¥ä½œæµçš„å¼€å§‹ |
| `TraceEventGraphEnd` | å›¾æ‰§è¡Œç»“æŸ | æ ‡è®°æ•´ä¸ªå·¥ä½œæµçš„æˆåŠŸå®Œæˆ |
| `TraceEventNodeStart` | èŠ‚ç‚¹å¼€å§‹ | æ ‡è®°å•ä¸ªèŠ‚ç‚¹çš„å¼€å§‹æ‰§è¡Œ |
| `TraceEventNodeEnd` | èŠ‚ç‚¹ç»“æŸ | æ ‡è®°å•ä¸ªèŠ‚ç‚¹çš„æˆåŠŸå®Œæˆ |
| `TraceEventNodeError` | èŠ‚ç‚¹é”™è¯¯ | æ ‡è®°èŠ‚ç‚¹æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ |
| `TraceEventEdgeTraversal` | è¾¹éå† | æ ‡è®°èŠ‚ç‚¹é—´çš„æ§åˆ¶æµè½¬ç§» |

### ä¸Šä¸‹æ–‡ä¼ æ’­

Tracing ç³»ç»Ÿé€šè¿‡ä¸Šä¸‹æ–‡ä¼ æ’­æ”¯æŒåˆ†å¸ƒå¼è¿½è¸ªï¼š

```mermaid
sequenceDiagram
participant GC as GraphContext
participant TS as Tracer
participant SP as Span
participant H as Hook
GC->>TS : StartSpan(ctx, event, nodeName)
TS->>SP : åˆ›å»ºæ–°Span
TS->>SP : è®¾ç½®ParentIDä»ä¸Šä¸‹æ–‡æå–
TS->>H : é€šçŸ¥æ‰€æœ‰Hook
SP->>GC : è¿”å›Span
GC->>SP : EndSpan(ctx, span, state, err)
SP->>H : é€šçŸ¥æ‰€æœ‰Hook
```

**å›¾è¡¨æ¥æº**
- [graph/tracing.go](file://graph/tracing.go#L103-L148)

### ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆ

è™½ç„¶å½“å‰ç‰ˆæœ¬ä¸»è¦å…³æ³¨å†…éƒ¨è¿½è¸ªï¼Œä½† Tracer æ¥å£è®¾è®¡ä¸ºæ”¯æŒå¤–éƒ¨ç³»ç»Ÿé›†æˆï¼š

```mermaid
flowchart LR
A[Tracer] --> B[TraceHookæ¥å£]
B --> C[OpenTelemetry Hook]
B --> D[è‡ªå®šä¹‰Hook]
B --> E[æ‰¹é‡å¤„ç†Hook]
C --> F[Jaeger]
C --> G[Zipkin]
C --> H[Prometheus]
D --> I[æ—¥å¿—ç³»ç»Ÿ]
D --> J[ç›‘æ§ä»ªè¡¨æ¿]
E --> K[æ•°æ®èšåˆ]
E --> L[æ€§èƒ½åˆ†æ]
```

**ç« èŠ‚æ¥æº**
- [graph/tracing.go](file://graph/tracing.go#L1-L287)

## Command API åŠ¨æ€æ§åˆ¶æµ

### æ ¸å¿ƒæ¦‚å¿µ

Command API å…è®¸èŠ‚ç‚¹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€æ§åˆ¶æµç¨‹ï¼Œæä¾›æ¯”é™æ€å›¾å®šä¹‰æ›´çµæ´»çš„æ§åˆ¶èƒ½åŠ›ã€‚

```mermaid
classDiagram
class Command {
+Update interface{}
+Goto interface{}
}
class ToolExecutor {
+tools map[string]tools.Tool
+Execute(ctx, invocation) string
+ExecuteMany(ctx, invocations) []string
+ToolNode(ctx, state)
}
class ToolInvocation {
+Tool string
+ToolInput string
}
Command --> ToolInvocation : "used by"
ToolExecutor --> Command : "returns"
ToolExecutor --> ToolInvocation : "processes"
```

**å›¾è¡¨æ¥æº**
- [graph/command.go](file://graph/command.go#L1-L15)
- [prebuilt/tool_executor.go](file://prebuilt/tool_executor.go#L1-L84)

### åŠ¨æ€è·¯ç”±æœºåˆ¶

Command API çš„æ ¸å¿ƒæ˜¯ `Command` ç»“æ„ä½“ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªå…³é”®å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | æè¿° | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| `Update` | `interface{}` | çŠ¶æ€æ›´æ–°å€¼ | åœ¨æ§åˆ¶æµæ”¹å˜å‰æ›´æ–°å›¾çŠ¶æ€ |
| `Goto` | `interface{}` | ä¸‹ä¸€èŠ‚ç‚¹æŒ‡å®š | è¦†ç›–é™æ€è¾¹ï¼ŒåŠ¨æ€æ§åˆ¶æ‰§è¡Œè·¯å¾„ |

### å®ç°åŸç†

```mermaid
flowchart TD
A[èŠ‚ç‚¹æ‰§è¡Œ] --> B{è¿”å›å€¼ç±»å‹}
B --> |æ™®é€šå€¼| C[æŒ‰é™æ€è¾¹æµè½¬]
B --> |*Command| D[è§£æCommand]
D --> E{Gotoå­—æ®µå­˜åœ¨?}
E --> |æ˜¯| F[è·³è½¬åˆ°æŒ‡å®šèŠ‚ç‚¹]
E --> |å¦| G[æŒ‰é™æ€è¾¹æµè½¬]
F --> H[åº”ç”¨Updateæ›´æ–°çŠ¶æ€]
G --> I[åº”ç”¨Updateæ›´æ–°çŠ¶æ€]
H --> J[ç»§ç»­æ‰§è¡Œ]
I --> J
```

**å›¾è¡¨æ¥æº**
- [examples/command_api/main.go](file://examples/command_api/main.go#L22-L40)

### å·¥å…·è°ƒç”¨ç¤ºä¾‹

ToolExecutor å±•ç¤ºäº†å¦‚ä½•åœ¨å®é™…åœºæ™¯ä¸­ä½¿ç”¨ Command APIï¼š

```mermaid
sequenceDiagram
participant TE as ToolExecutor
participant TI as ToolInvocation
participant T as Tool
participant N as Node
N->>TE : ToolNode(state)
TE->>TI : è§£æToolInvocation
TE->>T : Call(tool, input)
T->>TE : è¿”å›æ‰§è¡Œç»“æœ
TE->>N : è¿”å›ç»“æœæˆ–Command
N->>N : æ ¹æ®è¿”å›å€¼å†³å®šæµç¨‹
```

**å›¾è¡¨æ¥æº**
- [prebuilt/tool_executor.go](file://prebuilt/tool_executor.go#L57-L84)

### ä½¿ç”¨åœºæ™¯

Command API é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

1. **æ¡ä»¶è·¯ç”±**ï¼šåŸºäºèŠ‚ç‚¹æ‰§è¡Œç»“æœåŠ¨æ€é€‰æ‹©è·¯å¾„
2. **æ—©æœŸé€€å‡º**ï¼šåœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æå‰ç»ˆæ­¢æµç¨‹
3. **è·³è¿‡æ­¥éª¤**ï¼šæ ¹æ®ä¸šåŠ¡é€»è¾‘è·³è¿‡æŸäº›ä¸­é—´æ­¥éª¤
4. **åŠ¨æ€å¾ªç¯**ï¼šå®ç°å¤æ‚çš„å¾ªç¯æ§åˆ¶é€»è¾‘
5. **å·¥å…·è°ƒç”¨å†³ç­–**ï¼šæ ¹æ®å·¥å…·æ‰§è¡Œç»“æœè°ƒæ•´åç»­æµç¨‹

**ç« èŠ‚æ¥æº**
- [graph/command.go](file://graph/command.go#L1-L15)
- [prebuilt/tool_executor.go](file://prebuilt/tool_executor.go#L1-L84)
- [examples/command_api/main.go](file://examples/command_api/main.go#L1-L73)

## Streaming å®æ—¶æµå¼å¤„ç†

### æ¶æ„æ¦‚è§ˆ

Streaming ç³»ç»Ÿæä¾›äº†å®æ—¶äº‹ä»¶æµå¼å¤„ç†èƒ½åŠ›ï¼Œæ”¯æŒå¤šç§æµå¼æ¨¡å¼å’ŒèƒŒå‹å¤„ç†ã€‚

```mermaid
classDiagram
class StreamEvent {
+Timestamp time.Time
+NodeName string
+Event NodeEvent
+State interface{}
+Error error
+Metadata map[string]interface{}
+Duration time.Duration
}
class StreamingListener {
+eventChan chan StreamEvent
+config StreamConfig
+closed bool
+droppedEvents int
+mutex sync.RWMutex
+OnNodeEvent(ctx, event, nodeName, state, err)
+emitEvent(event)
+shouldEmit(event) bool
+Close()
+GetDroppedEventsCount() int
}
class StreamingRunnable {
+runnable *ListenableRunnable
+config StreamConfig
+Stream(ctx, initialState) *StreamResult
}
class StreamResult {
+Events chan StreamEvent
+Result chan interface{}
+Errors chan error
+Done chan struct{}
+Cancel context.CancelFunc
}
StreamingListener --> StreamEvent : "emits"
StreamingRunnable --> StreamResult : "produces"
StreamingRunnable --> StreamingListener : "uses"
```

**å›¾è¡¨æ¥æº**
- [graph/streaming.go](file://graph/streaming.go#L65-L423)

### æµå¼æ¨¡å¼

| æ¨¡å¼ | å€¼ | æè¿° | ä½¿ç”¨åœºæ™¯ |
|------|-----|------|----------|
| `StreamModeDebug` | `"debug"` | å‘å°„æ‰€æœ‰å†…éƒ¨äº‹ä»¶ | æ·±åº¦è°ƒè¯•å’Œé—®é¢˜æ’æŸ¥ |
| `StreamModeValues` | `"values"` | å‘å°„å®Œæ•´çŠ¶æ€å˜åŒ– | è°ƒè¯•å’ŒUIæ¸²æŸ“ |
| `StreamModeUpdates` | `"updates"` | å‘å°„èŠ‚ç‚¹è¾“å‡ºæ›´æ–° | è¿›åº¦æ˜¾ç¤ºå’ŒçŠ¶æ€è·Ÿè¸ª |
| `StreamModeMessages` | `"messages"` | å‘å°„æ¶ˆæ¯å’Œä»¤ç‰Œ | LLMæµå¼è¾“å‡º |

### èƒŒå‹å¤„ç†

Streaming ç³»ç»Ÿå®ç°äº†æ™ºèƒ½çš„èƒŒå‹å¤„ç†æœºåˆ¶ï¼š

```mermaid
flowchart TD
A[äº‹ä»¶äº§ç”Ÿ] --> B{é€šé“æ˜¯å¦æ»¡?}
B --> |å¦| C[å‘é€äº‹ä»¶]
B --> |æ˜¯| D{å¯ç”¨èƒŒå‹?}
D --> |æ˜¯| E[ä¸¢å¼ƒäº‹ä»¶]
D --> |å¦| F[é˜»å¡ç­‰å¾…]
C --> G[äº‹ä»¶å‘é€æˆåŠŸ]
E --> H[å¢åŠ ä¸¢å¼ƒè®¡æ•°]
F --> I{è¶…æ—¶?}
I --> |å¦| B
I --> |æ˜¯| J[æ”¾å¼ƒå‘é€]
```

**å›¾è¡¨æ¥æº**
- [graph/streaming.go](file://graph/streaming.go#L99-L109)

### æ‰§è¡Œæµç¨‹

```mermaid
sequenceDiagram
participant SR as StreamingRunnable
participant SL as StreamingListener
participant R as Runnable
participant N as Node
SR->>SL : åˆ›å»ºStreamingListener
SR->>R : InvokeWithConfig(config)
R->>SL : æ³¨å†Œä¸ºå›è°ƒå¤„ç†å™¨
loop æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œ
R->>N : æ‰§è¡ŒèŠ‚ç‚¹
N->>SL : OnNodeEvent
SL->>SL : shouldEmitè¿‡æ»¤
alt äº‹ä»¶è¢«å…è®¸
SL->>SR : å‘é€åˆ°äº‹ä»¶é€šé“
else äº‹ä»¶è¢«ä¸¢å¼ƒ
SL->>SL : å¢åŠ ä¸¢å¼ƒè®¡æ•°
end
end
R->>SR : è¿”å›æœ€ç»ˆç»“æœ
SR->>SL : å…³é—­ç›‘å¬å™¨
SL->>SR : å…³é—­æ‰€æœ‰é€šé“
```

**å›¾è¡¨æ¥æº**
- [graph/streaming.go](file://graph/streaming.go#L289-L357)

**ç« èŠ‚æ¥æº**
- [graph/streaming.go](file://graph/streaming.go#L1-L423)

## æ‰©å±•æœºåˆ¶é›†æˆ

### ç»¼åˆæ¶æ„

å¤šä¸ªæ‰©å±•æœºåˆ¶å¯ä»¥ååŒå·¥ä½œï¼Œæ„å»ºå®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼š

```mermaid
graph TB
subgraph "æ ¸å¿ƒæ‰§è¡Œå¼•æ“"
G[Graph]
N[Node]
S[State]
end
subgraph "ç›‘å¬å™¨å±‚"
PL[ProgressListener]
LL[LoggingListener]
ML[MetricsListener]
CL[ChatListener]
SL[StreamingListener]
end
subgraph "è¿½è¸ªå±‚"
T[Tracer]
TS[TraceSpan]
TH[TraceHook]
end
subgraph "å‘½ä»¤å±‚"
C[Command]
TE[ToolExecutor]
TN[ToolNode]
end
G --> N
N --> S
N --> PL
N --> LL
N --> ML
N --> CL
N --> SL
N --> T
N --> C
C --> TE
TE --> TN
T --> TS
TS --> TH
SL --> TS
```

### é…ç½®ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ç»¼åˆä½¿ç”¨å„ç§æ‰©å±•æœºåˆ¶çš„é…ç½®ç¤ºä¾‹ï¼š

```mermaid
flowchart TD
A[åˆ›å»ºListenableMessageGraph] --> B[æ·»åŠ ProgressListener]
A --> C[æ·»åŠ LoggingListener]
A --> D[æ·»åŠ MetricsListener]
A --> E[æ·»åŠ ChatListener]
A --> F[æ·»åŠ StreamingListener]
B --> G[è®¾ç½®èŠ‚ç‚¹æ­¥éª¤]
C --> H[é…ç½®æ—¥å¿—çº§åˆ«]
D --> I[æ”¶é›†æ€§èƒ½æŒ‡æ ‡]
E --> J[è®¾ç½®èŠå¤©æ¶ˆæ¯]
F --> K[é…ç½®æµå¼æ¨¡å¼]
G --> L[ç¼–è¯‘å¯ç›‘å¬çš„Runnable]
H --> L
I --> L
J --> L
K --> L
L --> M[æ‰§è¡Œå›¾]
M --> N[å®æ—¶äº‹ä»¶æµ]
M --> O[æ€§èƒ½æŠ¥å‘Š]
M --> P[è°ƒè¯•ä¿¡æ¯]
```

### ç›‘æ§å’Œè°ƒè¯•å·¥ä½œæµ

```mermaid
sequenceDiagram
participant U as ç”¨æˆ·
participant G as Graph
participant ML as MetricsListener
participant PL as ProgressListener
participant SL as StreamingListener
participant T as Tracer
U->>G : æ‰§è¡Œå·¥ä½œæµ
G->>ML : è®°å½•æ‰§è¡ŒæŒ‡æ ‡
G->>PL : æ˜¾ç¤ºè¿›åº¦æ›´æ–°
G->>SL : å‘é€å®æ—¶äº‹ä»¶
G->>T : åˆ›å»ºè¿½è¸ªSpan
loop æ‰§è¡Œè¿‡ç¨‹
G->>ML : æ›´æ–°æŒ‡æ ‡
G->>PL : æ˜¾ç¤ºè¿›åº¦
G->>SL : å‘é€äº‹ä»¶
G->>T : è®°å½•æ“ä½œ
end
G->>U : è¿”å›ç»“æœ
U->>ML : æŸ¥è¯¢æ€§èƒ½æŠ¥å‘Š
U->>SL : è®¢é˜…å®æ—¶äº‹ä»¶
U->>T : æŸ¥çœ‹è¿½è¸ªè¯¦æƒ…
```

**ç« èŠ‚æ¥æº**
- [examples/listeners/main.go](file://examples/listeners/main.go#L1-L132)

## æœ€ä½³å®è·µ

### ç›‘å¬å™¨ä½¿ç”¨å»ºè®®

1. **é€‰æ‹©åˆé€‚çš„ç›‘å¬å™¨ç±»å‹**
   - ä½¿ç”¨ ProgressListener è¿›è¡Œç”¨æˆ·ç•Œé¢åé¦ˆ
   - ä½¿ç”¨ LoggingListener è¿›è¡Œç”Ÿäº§ç¯å¢ƒæ—¥å¿—
   - ä½¿ç”¨ MetricsListener è¿›è¡Œæ€§èƒ½ç›‘æ§
   - ä½¿ç”¨ ChatListener æä¾›äº¤äº’å¼ä½“éªŒ

2. **é¿å…è¿‡åº¦ç›‘å¬**
   - ä¸è¦åœ¨é«˜é¢‘ç‡èŠ‚ç‚¹ä¸Šä½¿ç”¨é‡é‡çº§ç›‘å¬å™¨
   - è€ƒè™‘ä½¿ç”¨å¼‚æ­¥å¤„ç†å‡å°‘å¯¹ä¸»æµç¨‹çš„å½±å“
   - åˆç†è®¾ç½®ç›‘å¬å™¨çš„è¿‡æ»¤æ¡ä»¶

3. **èµ„æºç®¡ç†**
   - åŠæ—¶ç§»é™¤ä¸éœ€è¦çš„ç›‘å¬å™¨
   - å®ç°ç›‘å¬å™¨çš„æ¸…ç†é€»è¾‘
   - æ³¨æ„å†…å­˜æ³„æ¼é£é™©

### Tracing é›†æˆç­–ç•¥

1. **åˆ†å±‚è¿½è¸ª**
   - åœ¨ä¸åŒæŠ½è±¡å±‚æ¬¡ä½¿ç”¨ä¸åŒçš„è¿½è¸ªäº‹ä»¶
   - ä¿æŒè¿½è¸ªä¸Šä¸‹æ–‡çš„å®Œæ•´æ€§
   - åˆç†è®¾ç½®è¿½è¸ªé‡‡æ ·ç‡

2. **å¤–éƒ¨ç³»ç»Ÿé›†æˆ**
   - å®ç° TraceHook æ¥å£é€‚é…å¤–éƒ¨è¿½è¸ªç³»ç»Ÿ
   - å¤„ç†è¿½è¸ªæ•°æ®çš„æ‰¹é‡ä¼ è¾“
   - å®ç°è¿½è¸ªæ•°æ®çš„æœ¬åœ°ç¼“å­˜

### Command API ä½¿ç”¨æŒ‡å—

1. **çŠ¶æ€æ›´æ–°ç­–ç•¥**
   - ä½¿ç”¨ Schema/Reducer æ­£ç¡®åˆå¹¶çŠ¶æ€
   - é¿å…åœ¨ Command ä¸­ä¼ é€’å¤§å‹å¯¹è±¡
   - è€ƒè™‘çŠ¶æ€çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æˆæœ¬

2. **è·¯ç”±å†³ç­–**
   - ä¿æŒè·¯ç”±é€»è¾‘çš„ç®€å•æ€§å’Œå¯é¢„æµ‹æ€§
   - å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
   - é¿å…è¿‡äºå¤æ‚çš„åµŒå¥—è·¯ç”±

### Streaming æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å†²åŒºç®¡ç†**
   - æ ¹æ®å†…å­˜é™åˆ¶è®¾ç½®åˆç†çš„ç¼“å†²åŒºå¤§å°
   - å®ç°èƒŒå‹å¤„ç†ç­–ç•¥
   - ç›‘æ§ä¸¢å¼ƒäº‹ä»¶çš„æ•°é‡

2. **äº‹ä»¶è¿‡æ»¤**
   - ä½¿ç”¨é€‚å½“çš„æµå¼æ¨¡å¼å‡å°‘ä¸å¿…è¦çš„äº‹ä»¶
   - å®ç°å®¢æˆ·ç«¯ä¾§çš„äº‹ä»¶è¿‡æ»¤
   - è€ƒè™‘äº‹ä»¶å‹ç¼©å’Œä¼ è¾“ä¼˜åŒ–

## æ€»ç»“

LangGraph Go çš„æ‰©å±•æœºåˆ¶æä¾›äº†ä¸€ä¸ªå®Œæ•´è€Œçµæ´»çš„æ¡†æ¶ï¼Œæ”¯æŒå¼€å‘è€…åœ¨è¿è¡Œæ—¶ç›‘æ§ã€è°ƒè¯•å’Œæ§åˆ¶å¤æ‚çš„å·¥ä½œæµæ‰§è¡Œã€‚é€šè¿‡ Listener ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€Tracing æ¨¡å—çš„åˆ†å¸ƒå¼è¿½è¸ªã€Command API çš„åŠ¨æ€æ§åˆ¶æµå’Œ Streaming ç³»ç»Ÿçš„å®æ—¶äº‹ä»¶å¤„ç†ï¼Œè¿™äº›æœºåˆ¶å…±åŒæ„å»ºäº†ä¸€ä¸ªå¯è§‚å¯Ÿã€å¯è°ƒè¯•ä¸”é«˜åº¦å¯å®šåˆ¶çš„ç³»ç»Ÿæ¶æ„ã€‚

è¿™äº›æ‰©å±•æœºåˆ¶çš„è®¾è®¡éµå¾ªäº†å•ä¸€èŒè´£åŸåˆ™å’Œå¼€æ”¾å°é—­åŸåˆ™ï¼Œæ—¢ä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œåˆæä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§ã€‚é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›æ‰©å±•ç‚¹ï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºå‡ºåŠŸèƒ½å¼ºå¤§ã€æ˜“äºç»´æŠ¤çš„å¤æ‚å·¥ä½œæµç³»ç»Ÿã€‚

æœªæ¥çš„æ”¹è¿›æ–¹å‘åŒ…æ‹¬ï¼š
- æ›´å¥½çš„ OpenTelemetry é›†æˆ
- æ›´ä¸°å¯Œçš„å†…ç½®ç›‘å¬å™¨ç±»å‹
- æ›´æ™ºèƒ½çš„è‡ªåŠ¨é…ç½®å’Œä¼˜åŒ–
- æ›´å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶